<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Express, passport.js로 구글 소셜 로그인 구현하는 법 | Portfolio</title>
    <meta name="generator" content="VuePress 1.6.0">
    
    <meta name="description" content="Express, passport.js로 소셜 로그인 구현하는 법">
    <meta property="og:title" content="Express, passport.js로 소셜 로그인 구현하는 법">
    <meta property="og:description" content="Express, passport.js로 소셜 로그인 구현하는 법">
    <meta property="og:url" content="https://tjddus.github.io/HwangKim_site/node/general/">
    <link rel="preload" href="/HwangKim_site/assets/css/0.styles.cb3b7a94.css" as="style"><link rel="preload" href="/HwangKim_site/assets/js/app.cb70b314.js" as="script"><link rel="preload" href="/HwangKim_site/assets/js/2.535f0014.js" as="script"><link rel="preload" href="/HwangKim_site/assets/js/18.1cdaa71f.js" as="script"><link rel="prefetch" href="/HwangKim_site/assets/js/10.8c3cfde1.js"><link rel="prefetch" href="/HwangKim_site/assets/js/11.b1f59902.js"><link rel="prefetch" href="/HwangKim_site/assets/js/12.9b334a1a.js"><link rel="prefetch" href="/HwangKim_site/assets/js/13.862fbdbf.js"><link rel="prefetch" href="/HwangKim_site/assets/js/14.ae1fc274.js"><link rel="prefetch" href="/HwangKim_site/assets/js/15.28e19d48.js"><link rel="prefetch" href="/HwangKim_site/assets/js/16.95fc3f57.js"><link rel="prefetch" href="/HwangKim_site/assets/js/17.f8f95d69.js"><link rel="prefetch" href="/HwangKim_site/assets/js/3.5d2fbdc1.js"><link rel="prefetch" href="/HwangKim_site/assets/js/4.e1409063.js"><link rel="prefetch" href="/HwangKim_site/assets/js/5.7a7b0ebc.js"><link rel="prefetch" href="/HwangKim_site/assets/js/6.021ec49f.js"><link rel="prefetch" href="/HwangKim_site/assets/js/7.71d00570.js"><link rel="prefetch" href="/HwangKim_site/assets/js/8.9bb65b76.js"><link rel="prefetch" href="/HwangKim_site/assets/js/9.86994601.js">
    <link rel="stylesheet" href="/HwangKim_site/assets/css/0.styles.cb3b7a94.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/HwangKim_site/" class="home-link router-link-active"><!----> <span class="site-name">Portfolio</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/HwangKim_site/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/HwangKim_site/node/general/OAuth2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Node
</a></div><div class="nav-item"><a href="/HwangKim_site/devProject/" class="nav-link">
  개발프로젝트
</a></div><div class="nav-item"><a href="http://github.com/tjddus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/HwangKim_site/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/HwangKim_site/node/general/OAuth2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Node
</a></div><div class="nav-item"><a href="/HwangKim_site/devProject/" class="nav-link">
  개발프로젝트
</a></div><div class="nav-item"><a href="http://github.com/tjddus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>general</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/HwangKim_site/node/general/OAuth2.html" aria-current="page" class="active sidebar-link">Express, passport.js로 구글 소셜 로그인 구현하는 법</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#express-generator로-프로젝트-시작" class="sidebar-link">express-generator로 프로젝트 시작</a></li><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#소셜-로그인-설계-흐름" class="sidebar-link">소셜 로그인 설계 흐름</a></li><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#passport-js란" class="sidebar-link">passport.js란</a></li><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#code-작성" class="sidebar-link">Code 작성</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#router-작성" class="sidebar-link">router 작성</a></li><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#passport-작성" class="sidebar-link">passport 작성</a></li></ul></li><li class="sidebar-sub-header"><a href="/HwangKim_site/node/general/OAuth2.html#app-작성" class="sidebar-link">app 작성</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 style="font-family:'Nanum Gothic';">Express, passport.js로 구글 소셜 로그인 구현하는 법</h1> <p>나는 컴알못이다. 소셜 로그인을 구현해보기 위해 많은 구글링을 시도해보았지만....당연히 어렵다.
프로젝트를 시작하는 법조차도 까먹고... 그래서 프로젝트 시작부터 내가 구현해나간 과정을 자세히 적어보려고 한다.</p> <h2 id="express-generator로-프로젝트-시작"><a href="#express-generator로-프로젝트-시작" class="header-anchor">#</a> express-generator로 프로젝트 시작</h2> <ol><li><strong>npm init</strong> 작업을 통해 모듈을 작성, 관리하기 위해 package.json 생성</li> <li>express 프레임워크를 사용할 때, 프로젝트 전체 구조를 자동으로 잡기 위해 express-generator 설치</li> <li><strong>express --view=pug myapp</strong>을 통해 전역으로 모듈을 설치할 수는 있겠지만, 가능하면 전역으로 설치하지 않기 위해 나는 npx 명령을 이용해 프로젝트 구조을 잡아줌</li> <li>이렇게 <strong>--view=pug</strong>뒤에 붙는 명령어는 템플릿을 pug파일로 작성하기 위함</li> <li>package.json을 보면 내부 설치해야할 모듈이 나타났기 때문에 모듈을 자동으로 설치하는 명령어인 <strong>npm install</strong> 작성</li> <li>이 상태로 프로젝트를 진행하면 npm start를 했을 경우 서버가 켜진 상태에서 코드를 수정해도 수정사항이 바로 반영되지 않기 때문에
계속 재시작 해야한다. 재시작하지 않고 코드 수정 시 바로 반영될 수 있게 <strong>npm install nodemon -d</strong>를 해줌</li></ol> <p><code>shell</code></p> <div class="language-shell script extra-class"><pre class="language-shell"><code><span class="token function">npm</span> init
<span class="token function">npm</span> <span class="token function">install</span> express <span class="token operator">|</span> <span class="token function">npm</span> <span class="token function">install</span> -g express
<span class="token function">npm</span> <span class="token function">install</span> express-generator

npx express-generator ./ --view<span class="token operator">=</span>pug
<span class="token function">npm</span> <span class="token function">install</span>

옵션<span class="token punctuation">)</span> <span class="token function">npm</span> <span class="token function">install</span> nodemon -d
</code></pre></div><p><code>package.json</code></p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon ./bin/www&quot;</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="소셜-로그인-설계-흐름"><a href="#소셜-로그인-설계-흐름" class="header-anchor">#</a> 소셜 로그인 설계 흐름</h2> <ol><li>로그인 페이지에서 구글 로그인하기 버튼 클릭하면 구글 로그인 페이지로 넘어간다</li> <li>구글 로그인 완료 시 '/'에 계정 이름이 뜬다.</li> <li>구글 로그인 실패 시 다시 '/login' 페이지로 돌아간다.</li> <li>새로고침을 해도 1시간 동안은 로그인이 유지된다.</li></ol> <img width="220" src="/HwangKim_site/OAuth1.png"> <img width="220" src="/HwangKim_site/OAuth2.png"> <img width="220" src="/HwangKim_site/OAuth3.png"> <h2 id="passport-js란"><a href="#passport-js란" class="header-anchor">#</a> passport.js란</h2> <p>passport란 node.js에서 인증 미들웨어다. 만약 사이트를 새로고침할 때마다 로그인을 하라고 하면... 생각만해도
passport는 로그인,관리자 접근제한 등과 같이 여권처럼 사용자를 인증하는 기능을 구현할 때 사용된다. 추가로 구글, 네이버 등 소셜 로그인을 하기 위해 용이하다.</p> <h2 id="code-작성"><a href="#code-작성" class="header-anchor">#</a> Code 작성</h2> <h3 id="router-작성"><a href="#router-작성" class="header-anchor">#</a> router 작성</h3> <p><code>GET '/'</code> <br>
router/middleware.js에 적어둔 authenticateUser 미들웨어를 통과해서 로그인이 완료된 경우는 index.pug를 보여준다.
router/middleware.js는 아래에서 더 적어보도록 하겠다.<br> <code>GET '/login'</code><br>
login.pug 페이지를 보여준다.<br> <code>GET '/auth/google'</code><br>
구글 로그인 페이지로 이동시킨다. scope의 경우 내가 구글 인증을 통해 받아올 정보이다.
나는 여기서 profile과 email 정보를 받도록 했다.<br> <code>GET '/auth/google/callback'</code><br>
'/auth/google/callback'은 구글 인증이 성공해서 들어오면 '/', 실패하면 다시 '/login'으로 돌아가도록 한다.<br></p> <p><code>router/index.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> authenticateUser<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'Express'</span><span class="token punctuation">,</span> user<span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>displayName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token string">'Login'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/auth/google'</span><span class="token punctuation">,</span>passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'google'</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{</span>scope<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/auth/google/callback'</span><span class="token punctuation">,</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">'google'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        failureRedirect<span class="token operator">:</span> <span class="token string">'/login'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="passport-작성"><a href="#passport-작성" class="header-anchor">#</a> passport 작성</h3> <p>프로젝트 내에 passport 폴더 생성하고 내부에 index.js와 GoogleStrategy.js 만든다.</p> <div class="language-shell script extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> passport passport-google-oauth20 express-session
</code></pre></div><p><code>index.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">const</span> googleStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./GoogleStrategy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'passport index 통과'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token comment">//serializerUser 미들웨어는 전달받은 객체(정보)를 세션에 저장하는 역할을 한다</span>
           <span class="token comment">//저장 객체를 deserializeUser 미들웨어로 전달</span>
           <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token comment">//deserializeUser 미들웨어는 서버로 들어오는 요청마다 세션 정보가 유효한 지를 검사하는 역할을 함</span>
           <span class="token comment">// req.user에 정보를 저장하고 요청마다 유저 정보를 넘겨준다.</span>
           <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">googleStrategy</span><span class="token punctuation">(</span>passport<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>GoogleStrategy.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> GoogleStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'passport-google-oauth20'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Strategy<span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">passport</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GoogleStrategy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            clientID<span class="token operator">:</span> <span class="token constant">CLIENT_ID</span><span class="token punctuation">,</span>
            clientSecret<span class="token operator">:</span> <span class="token constant">CLIENT_SERCRET</span><span class="token punctuation">,</span>
            callbackURL<span class="token operator">:</span> <span class="token string">'http://localhost:8080/auth/google/callback'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">accessToken<span class="token punctuation">,</span> refreshToken<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="app-작성"><a href="#app-작성" class="header-anchor">#</a> app 작성</h2></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/HwangKim_site/assets/js/app.cb70b314.js" defer></script><script src="/HwangKim_site/assets/js/2.535f0014.js" defer></script><script src="/HwangKim_site/assets/js/18.1cdaa71f.js" defer></script>
  </body>
</html>
